<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ガチャツール</title>
<style>
html,body{margin:0;padding:0;font-family:Arial,sans-serif;background:#fafafa;}
#mainWrapper{padding:15px;}

.section{
  background:#fff;padding:15px;margin-bottom:15px;border-radius:10px;
  box-shadow:0 0 4px rgba(0,0,0,0.1);
}

input[type="number"],input[type="text"],select{
  width:95%;padding:8px;margin:5px 0;border-radius:5px;
  border:1px solid #aaa;font-size:14px;
}

button{cursor:pointer;border:none;border-radius:6px;}
.add-btn{margin-top:10px;padding:8px 15px;background:#55aaff;color:#fff;}

.gacha-btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.gacha-btns button{
  flex:1;min-width:30%;padding:12px;font-size:16px;background:#ffb34d;color:#fff;
}

.preset-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}
.preset-grid button{
  padding:14px;font-size:16px;background:#7aa8ff;color:#fff;
}

.copy-btn{margin-top:5px;padding:6px 12px;background:#66cc66;color:#fff;}
.clear-btn{margin-top:10px;padding:10px 15px;background:#ff6666;color:#fff;}
.save-btn{margin-top:10px;padding:10px 15px;background:#6666ff;color:#fff;}

.N{color:#00ccff;} .R{color:#0055ff;}
.SR{color:#aa00ff;} .UR{color:#ff55aa;}
.LR{color:#ff0000;}

#logContainer{
  display:flex;
  flex-direction: column;
  gap:15px;
}

#summary, #log{
  background:#f8f8f8; padding:10px; border-radius:8px; 
  max-height:500px; overflow:auto;
}

.log-block{margin-bottom:10px; border-bottom:1px solid #ccc; padding-bottom:5px;}
.old-log{display:none; font-size:0.9em; color:#333;}
pre{white-space:pre-wrap;}
</style>
</head>
<body>
<div id="mainWrapper">

<!-- プリセット -->
<div class="section">
  <label>確率プリセット</label>
  <div class="preset-grid">
    <button onclick="setPreset('normal')">通常</button>
    <button onclick="setPreset('hard')">キツめ</button>
    <button onclick="setPreset('veryhard')">極悪</button>
    <button onclick="setPreset('hell')">地獄</button>
    <button onclick="applyCustom()">カスタム適用</button>
  </div>
</div>

<!-- 天井設定 -->
<div class="section">
  <label><input type="checkbox" id="ceilingSwitch" onchange="toggleCeiling()"> 天井機能を有効にする</label>
  <div id="ceilingSettings" style="display:none; margin-top:10px;">
    <label>天井規定回数：<input type="number" id="ceilingCount" value="10"></label><br>
    <label>天井対象レアリティ（複数選択可）：</label><br>
    <select id="ceilingRarity" multiple style="width:95%;height:80px;">
      <option value="N" selected>N</option>
      <option value="R" selected>R</option>
      <option value="SR" selected>SR</option>
      <option value="UR" selected>UR</option>
      <option value="LR" selected>LR</option>
    </select>
  </div>
</div>

<!-- カスタム確率 -->
<div class="section">
  <label><b>選択中プリセット：</b> <span id="presetName">通常</span></label><br><br>
  <label>カスタム確率設定（%）</label><br>
  N  <input id="rateN" type="number" value="40"><br>
  R  <input id="rateR" type="number" value="30"><br>
  SR <input id="rateSR" type="number" value="20"><br>
  UR <input id="rateUR" type="number" value="7"><br>
  LR <input id="rateLR" type="number" value="3"><br>
</div>

<!-- 景品登録 -->
<div class="section" id="itemSection">
  <label>景品登録</label>
  <div id="items"></div>
  <button class="add-btn" onclick="addItem()">＋ 景品追加</button>
</div>

<!-- プレイヤー登録欄 -->
<div class="section">
  <label>ガチャを回す人：</label><br>
  <input id="playerName" type="text" placeholder="名前を入力">
  <button class="add-btn" onclick="addPlayer()">名前を追加</button><br>

  <label>下から選択：</label>
  <select id="playerSelect"></select>
</div>

<!-- ガチャ実行 -->
<div class="section">
  <label>ガチャを回す</label><br>
  <div class="gacha-btns">
    <button onclick="roll(1)">1回</button>
    <button onclick="roll(5)">5回</button>
    <button onclick="roll(10)">10回</button>
  </div>
  <input id="customRoll" type="number" placeholder="任意の回数">
  <button style="margin-top:10px;width:100%;padding:10px;" onclick="rollCustom()">この回数で回す</button>
</div>

<!-- 結果ログ -->
<div class="section">
  <label>ガチャ結果ログ</label><br>

  <label>名前で絞り込み：</label>
  <select id="logFilter" onchange="displayLog()"></select>

  <label>表示順：</label>
  <select id="sortOrder" onchange="displayLog()">
    <option value="desc" selected>新しい順</option>
    <option value="asc">古い順</option>
  </select>

  <div id="logControls">
    <button class="clear-btn" onclick="clearLog()" style="margin-right:10px;">全ログ消去</button>
    <button class="save-btn" onclick="saveLog()">ログをtxt保存</button>
  </div>

  <div id="logContainer">
    <div id="log"></div>
    <div id="summary"></div>
  </div>
</div>

</div>

<script>
let players=[], logData=[], ceilingCounter={};
addItem();

/* プレイヤー管理 */
function addPlayer(){
  const name=document.getElementById("playerName").value.trim();
  if(!name || players.includes(name)) return;
  players.push(name); ceilingCounter[name]=0;
  updatePlayerUI(); document.getElementById("playerName").value="";
}
function updatePlayerUI(){
  const sel=document.getElementById("playerSelect");
  const filter=document.getElementById("logFilter");
  sel.innerHTML=""; filter.innerHTML='<option value="">全員</option>';
  players.forEach(name=>{
    let opt=document.createElement("option"); opt.value=name; opt.text=name; sel.add(opt);
    let opt2=document.createElement("option"); opt2.value=name; opt2.text=name; filter.add(opt2);
  });
}

/* 景品登録 */
function addItem(){
  const div=document.createElement("div");
  div.style.marginTop='8px';
  div.innerHTML=`
    <input type="text" placeholder="景品名">
    <select>
      <option>N</option><option>R</option><option>SR</option><option>UR</option><option>LR</option>
    </select>
    <button onclick="this.parentNode.remove()">×</button>
  `;
  document.getElementById('items').appendChild(div);
}

/* プリセット */
function setPreset(type){
  const preset={
    normal:{N:40,R:30,SR:20,UR:7,LR:3},
    hard:{N:60,R:25,SR:10,UR:4,LR:1},
    veryhard:{N:70,R:20,SR:8,UR:1.5,LR:0.5},
    hell:{N:79.9,R:19,SR:1,UR:0.9,LR:0.1}
  };
  const p=preset[type];
  rateN.value=p.N; rateR.value=p.R; rateSR.value=p.SR; rateUR.value=p.UR; rateLR.value=p.LR;
  const name={normal:"通常",hard:"キツめ",veryhard:"極悪",hell:"地獄"};
  document.getElementById("presetName").textContent=name[type];
}
function applyCustom(){document.getElementById("presetName").textContent="カスタム"; alert("カスタム確率を適用しました");}

/* 天井表示切替 */
function toggleCeiling(){
  document.getElementById("ceilingSettings").style.display=document.getElementById("ceilingSwitch").checked?"block":"none";
}

/* ガチャ本体 */
function roll(times){
  const player=document.getElementById("playerSelect").value;
  if(!player){alert("名前を選択してください");return;}
  const results=[], items=document.querySelectorAll("#items > div");
  const pool={N:[],R:[],SR:[],UR:[],LR:[]};
  items.forEach(n=>{
    let name=n.querySelector("input").value.trim();
    let rarity=n.querySelector("select").value;
    if(name) pool[rarity].push(name);
  });
  const rates={N:parseFloat(rateN.value),R:parseFloat(rateR.value),SR:parseFloat(rateSR.value),UR:parseFloat(rateUR.value),LR:parseFloat(rateLR.value)};
  const ceilingOn=document.getElementById("ceilingSwitch").checked;
  const ceilingLimit=parseInt(document.getElementById("ceilingCount").value);
  const ceilingRarities=[...document.getElementById("ceilingRarity").selectedOptions].map(o=>o.value);

  for(let i=0;i<times;i++){
    let isCeiling=false;
    if(ceilingOn && ceilingCounter[player]+1>=ceilingLimit){
      isCeiling=true;
      ceilingCounter[player]=0;
    }else{
      ceilingCounter[player]++;
    }

    let pick;
    if(isCeiling){
      const ceilingPool=[];
      ceilingRarities.forEach(r=>{if(pool[r].length>0) ceilingPool.push(...pool[r].map(n=>({name:n,rarity:r})));});
      if(ceilingPool.length===0){
        results.push({name:"指定レアリティの景品が見当たりません", rarity:"", ceiling:true});
        continue;
      }
      pick=ceilingPool[Math.floor(Math.random()*ceilingPool.length)];
      pick.ceiling=true;
    }else{
      let keys=[],weights=[];
      for(let r in rates){if(pool[r].length>0){keys.push(r);weights.push(rates[r]);}}
      const rKey=randomChoice(keys,weights);
      pick={name:pool[rKey][Math.floor(Math.random()*pool[rKey].length)], rarity:rKey};
    }
    results.push(pick);
  }

  addLog(player,results,times);
}

function rollCustom(){const n=parseInt(document.getElementById("customRoll").value); if(n>0) roll(n);}
function randomChoice(keys,weights){const sum=weights.reduce((a,b)=>a+b,0); let r=Math.random()*sum; for(let i=0;i<keys.length;i++){if(r<weights[i]) return keys[i]; r-=weights[i];}}

/* ログ表示 */
function addLog(player,results,times){
  logData.push({player,results,times});
  displayLog();
}

function displayLog(){
  const filter=document.getElementById("logFilter").value;
  const sortOrder=document.getElementById("sortOrder").value;
  const summaryDiv=document.getElementById("summary");
  const logDiv=document.getElementById("log");
  summaryDiv.innerHTML=""; logDiv.innerHTML="";

  let filteredLogs = logData.filter(entry=>filter===""||entry.player===filter);
  if(sortOrder==="desc") filteredLogs = filteredLogs.slice().reverse();

  let totalSummary={}, totalTimes=0;
  let latestLogs=[], oldLogs=[];

  filteredLogs.forEach((entry,idx)=>{
    totalTimes += entry.times;

    // 天井アイテムと通常アイテムを分ける
    const ceilingItems = entry.results.filter(r=>r.ceiling);
    const normalItems = entry.results.filter(r=>!r.ceiling);

    // 通常アイテムは同じものをまとめる
    const normalCount = {};
    normalItems.forEach(r=>{
      const key = r.rarity ? `【${r.rarity}】${r.name}` : r.name;
      normalCount[key] = (normalCount[key]||0)+1;
      totalSummary[key] = (totalSummary[key]||0)+1;
    });

    // 天井アイテムは個別表示（集計には含める）
    ceilingItems.forEach(r=>{
      const key = r.rarity ? `【${r.rarity}】${r.name}` : r.name;
      totalSummary[key] = (totalSummary[key]||0)+1;
    });

    // ログ用テキスト作成
    let logText = '';
    for(const [key,count] of Object.entries(normalCount)){
      logText += `  ${key} ×${count}個\n`;
    }
    ceilingItems.forEach(r=>{
      const key = r.rarity ? `【${r.rarity}】${r.name}` : r.name;
      logText += `  ${key} (天井) ×1個\n`;
    });

    const logBlock = {
      html:`<div class="log-block"><b>${entry.player}（${entry.times}回）</b><pre>${logText}</pre><button class="copy-btn" onclick='navigator.clipboard.writeText(\`${entry.player}(${entry.times}回)\n${logText}\`)'>コピー</button></div>`
    };

    if(sortOrder==="desc" ? idx<3 : idx>=filteredLogs.length-3){
      latestLogs.push(logBlock);
    }else{
      oldLogs.push(logBlock);
    }
  });

  latestLogs.forEach(l=>{logDiv.innerHTML+=l.html;});
  if(oldLogs.length>0){
    const oldDiv=document.createElement("div");
    oldDiv.className="old-log";
    oldLogs.forEach(l=>{oldDiv.innerHTML+=l.html;});
    const toggleBtn=document.createElement("button");
    toggleBtn.textContent="古いログを展開";
    toggleBtn.onclick=()=>{oldDiv.style.display=(oldDiv.style.display==="none"?"block":"none");};
    logDiv.appendChild(toggleBtn);
    logDiv.appendChild(oldDiv);
  }

  // 集計表示（天井フラグは無視）
  const sumText=Object.entries(totalSummary).map(([k,v])=>`${k}: ${v}個`).join("\n");
  const sumTitle = filter==="" ? `全員(${totalTimes}回)` : `${filter}(${totalTimes}回)`;
  summaryDiv.innerHTML=`<b>集計結果（${sumTitle}）</b><br><pre>${sumText}</pre>
    <button class="copy-btn" onclick='navigator.clipboard.writeText(\`${sumTitle}\n${sumText}\`)'>コピー</button>
    <button class="save-btn" onclick='saveSummary(\`${sumTitle}\n${sumText}\`)'>txt保存</button>`;
}

/* フィルター・消去・保存 */
function clearLog(){if(confirm("全ログと登録名を削除しますか？")){logData=[];players=[];ceilingCounter={};updatePlayerUI();displayLog();}}
function saveLog(){
  let all="";
  logData.forEach(entry=>{
    const ceilingItems = entry.results.filter(r=>r.ceiling);
    const normalItems = entry.results.filter(r=>!r.ceiling);

    // 通常はまとめて
    const normalCount = {};
    normalItems.forEach(r=>{
      const key = r.rarity ? `【${r.rarity}】${r.name}` : r.name;
      normalCount[key] = (normalCount[key]||0)+1;
    });

    let txt = '';
    for(const [key,count] of Object.entries(normalCount)){
      txt += `${key} ×${count}個\n`;
    }
    ceilingItems.forEach(r=>{
      const key = r.rarity ? `【${r.rarity}】${r.name}` : r.name;
      txt += `${key} (天井) ×1個\n`;
    });

    all += `${entry.player}(${entry.times}回)\n${txt}\n\n`;
  });

  const blob=new Blob([all],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="gacha_log.txt"; a.click();
  URL.revokeObjectURL(url);
}
function saveSummary(text){const blob=new Blob([text],{type:"text/plain"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="gacha_summary.txt"; a.click(); URL.revokeObjectURL(url);}
</script>
</body>
</html>
