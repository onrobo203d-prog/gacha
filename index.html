<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ガチャツール</title>

<style>
    body { font-family: sans-serif; padding: 15px; background: #f5f5f5; }

    h2 { margin-top: 25px; }
    button {
        padding: 10px 14px;
        font-size: 16px;
        margin: 4px;
        border-radius: 8px;
        border: none;
        background: #4a7bd0;
        color: white;
        cursor: pointer;
    }
    button:hover { opacity: 0.85; }

    .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-bottom: 10px;
    }

    .box {
        background: white;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 15px;
    }

    textarea, input, select {
        width: 100%;
        padding: 8px;
        font-size: 15px;
        margin-top: 5px;
        border-radius: 6px;
        border: 1px solid #aaa;
    }

    .rarity-block {
        background: #eef2ff;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    details {
        margin-top: 10px;
        background: #fff;
        padding: 10px;
        border-radius: 6px;
    }

</style>
</head>
<body>

<!-- 名前・ガチャ担当 -->
<div class="box">
    <label>下から選択：</label>
    <select id="nameSelect"></select>

    <input id="nameInput" type="text" placeholder="名前を追加">
    <button onclick="addName()">追加</button>
</div>

<!-- プリセット＋カスタム -->
<div class="box">
    <h3>プリセット / カスタム</h3>

    <div class="two-col">
        <button onclick="loadPreset('easy')">EASY</button>
        <button onclick="loadPreset('normal')">NORM</button>
        <button onclick="loadPreset('hard')">HARD</button>
        <button onclick="loadPreset('hell')">HELL</button>

        <!-- カスタム1 / 2 -->
        <button onclick="loadCustom(1)">カスタム1</button>
        <button onclick="loadCustom(2)">カスタム2</button>
    </div>

    <div class="box" id="customArea" style="display:none;">
        <h4>カスタム編集</h4>
        <div id="rarityContainer"></div>
        <button onclick="addRarity()">レアリティ追加</button>
        <button onclick="saveCustom()">保存</button>
    </div>
</div>

<!-- ガチャ実行 -->
<div class="box">
    <h3>ガチャを回す</h3>
    <button onclick="rollGacha()">1回回す</button>
    <button onclick="rollMulti(10)">10連</button>
</div>

<!-- 集計結果 -->
<div class="box">
    <h3>景品別集計</h3>
    <div id="summary"></div>
    <button onclick="copySummary()">コピー</button>
    <button onclick="saveText(summary.innerText,'summary.txt')">txt保存</button>
</div>

<!-- 詳細ログ（折りたたみ） -->
<div class="box">
    <details>
        <summary>詳細ログ（開く）</summary>
        <pre id="log"></pre>
        <button onclick="copyLog()">コピー</button>
        <button onclick="saveText(log.innerText,'log.txt')">txt保存</button>
    </details>
</div>

<!-- 全ログ消去 → 名前も消す -->
<div class="box">
    <button onclick="clearAll()">全ログ消去（名前も消える）</button>
</div>

<script>
/* ------------------------------
   保存領域
------------------------------ */
let rarities = [];           // 今選んでいるレアリティ構成
let currentCustom = null;    // 1 or 2
let logData = [];
let names = [];

/* ------------------------------
   画面初期化
------------------------------ */
window.onload = () => {
    loadNames();
    loadCustomButtons();
};

/* ------------------------------
   名前管理
------------------------------ */
function loadNames() {
    names = JSON.parse(localStorage.getItem("names") || "[]");
    const sel = document.getElementById("nameSelect");
    sel.innerHTML = "";
    names.forEach(n => {
        const op = document.createElement("option");
        op.textContent = n;
        sel.appendChild(op);
    });
}

function addName() {
    const v = nameInput.value.trim();
    if (!v) return;
    names.push(v);
    localStorage.setItem("names", JSON.stringify(names));
    nameInput.value = "";
    loadNames();
}

/* ------------------------------
   プリセット
------------------------------ */
function loadPreset(type) {
    currentCustom = null;
    customArea.style.display = "none";

    if (type === "easy") {
        rarities = [
            { name:"N", rate:70, items:["普通のグッズA","普通のグッズB"] },
            { name:"R", rate:25, items:["ちょいレアC"] },
            { name:"SR", rate:5, items:["SRグッズ"] },
        ];
    }
    if (type === "normal") {
        rarities = [
            { name:"N", rate:60, items:["普通1","普通2"] },
            { name:"R", rate:30, items:["Rグッズ"] },
            { name:"SR", rate:9, items:["SRグッズ"] },
            { name:"LR", rate:1, items:["LRグッズ"] }
        ];
    }
    if (type === "hard") {
        rarities = [
            { name:"N", rate:40, items:["N1","N2"] },
            { name:"R", rate:40, items:["R1"] },
            { name:"SR", rate:18, items:["SR"] },
            { name:"LR", rate:2, items:["LR"] }
        ];
    }
    if (type === "hell") {
        rarities = [
            { name:"N", rate:80, items:["N1"] },
            { name:"R", rate:19, items:["R1"] },
            { name:"LR", rate:1, items:["地獄LR"] }
        ];
    }

    renderSummary();
}

/* ------------------------------
   カスタム読み込み
------------------------------ */
function loadCustom(num) {
    currentCustom = num;
    customArea.style.display = "block";

    let data = localStorage.getItem("custom" + num);
    if (data) {
        rarities = JSON.parse(data);
    } else {
        rarities = [];
    }
    renderCustomEditor();
}

/* ------------------------------
   カスタム編集UI
------------------------------ */
function renderCustomEditor() {
    const area = document.getElementById("rarityContainer");
    area.innerHTML = "";

    rarities.forEach((r, idx) => {
        const div = document.createElement("div");
        div.className = "rarity-block";
        div.innerHTML = `
            レアリティ名：<input value="${r.name}" onchange="updateRarityName(${idx}, this.value)">
            確率：<input type="number" value="${r.rate}" onchange="updateRarityRate(${idx}, this.value)">
            景品一覧（1行＝1種）：
            <textarea rows="4" onchange="updateRarityItems(${idx}, this.value)">${r.items.join("\n")}</textarea>
        `;
        area.appendChild(div);
    });
}

/* 更新系 */
function updateRarityName(i, val) { rarities[i].name = val; }
function updateRarityRate(i, val) { rarities[i].rate = Number(val); }
function updateRarityItems(i, val) { rarities[i].items = val.split("\n").filter(x=>x); }

function addRarity() {
    rarities.push({ name:"NEW", rate:0, items:["景品"] });
    renderCustomEditor();
}

function saveCustom() {
    if (!currentCustom) return;
    localStorage.setItem("custom" + currentCustom, JSON.stringify(rarities));
    alert("カスタム" + currentCustom + " を保存しました");
}

/* ------------------------------
   ガチャ処理
------------------------------ */
function rollOnce() {
    let total = rarities.reduce((a,b)=>a+b.rate,0);
    let r = Math.random() * total;

    for (let rt of rarities) {
        if (r < rt.rate) {
            const item = rt.items[Math.floor(Math.random()*rt.items.length)];
            return { rarity: rt.name, item };
        }
        r -= rt.rate;
    }
}

function rollGacha() {
    const name = nameSelect.value || "名無し";
    const r = rollOnce();
    logData.push(`[${name}] 【${r.rarity}】${r.item}`);
    renderSummary();
}

function rollMulti(n) {
    const name = nameSelect.value || "名無し";
    for (let i=0;i<n;i++){
        const r = rollOnce();
        logData.push(`[${name}] 【${r.rarity}】${r.item}`);
    }
    renderSummary();
}

/* ------------------------------
   集計表示
------------------------------ */
function renderSummary() {
    const sum = {};
    logData.forEach(line=>{
        const m = line.match(/【(.+?)】(.+)/);
        if (!m) return;
        const rarity = m[1];
        const item = m[2];
        const key = rarity + "___" + item;
        sum[key] = (sum[key]||0)+1;
    });

    // レアリティ順ソート
    const keys = Object.keys(sum).sort((a,b)=>{
        const ra = a.split("___")[0];
        const rb = b.split("___")[0];
        return ra.localeCompare(rb);
    });

    let html = "";
    keys.forEach(k=>{
        const [rar,item] = k.split("___");
        html += `【${rar}】${item}：${sum[k]}個<br>`;
    });

    summary.innerHTML = html;
    log.innerText = logData.join("\n");
}

/* ------------------------------
   コピー／保存
------------------------------ */
function copyLog(){ navigator.clipboard.writeText(log.innerText); }
function copySummary(){ navigator.clipboard.writeText(summary.innerText); }

function saveText(text, filename){
    const blob = new Blob([text], {type:"text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

/* ------------------------------
   全消去（ログ＋名前）
------------------------------ */
function clearAll(){
    if (!confirm("本当に全部消去しますか？\nログ・名前・カスタム以外すべて消えます")) return;

    logData = [];
    localStorage.removeItem("names");
    names = [];
    loadNames();
    renderSummary();
}
</script>

</body>
</html>
